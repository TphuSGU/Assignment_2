name: Test Performance With K6

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

jobs:
  backend-compose:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Start backend + services
        run: |
          cd FloginFE_BE/backend
          docker compose up -d --build

      - name: Wait for services to be ready
        run: |
          # Chờ MySQL
          echo "Waiting for MySQL..."
          timeout 60s bash -c 'until docker compose exec mysql mysqladmin ping -uroot -proot --silent; do sleep 2; done'
          
          # Chờ backend
          echo "Waiting for backend..."
          timeout 60s bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 5; done'

      - name: Check service status
        run: |
          docker compose ps
          curl -v http://localhost:8080/actuator/health

      - name: Test database connection
        run: |
          docker compose exec mysql mysql -uroot -proot -e "SHOW DATABASES;"

#      - name: Run performance tests with K6
#        uses: grafana/k6-action@v0.3.1
#        with:
#          filename: scripts/test.js  # Thay bằng file test K6 của bạn